import*as THREE from"three";import{GLTFLoader}from"three/examples/jsm/loaders/GLTFLoader.js";import{DRACOLoader}from"three/examples/jsm/loaders/DRACOLoader.js";import{OrbitControls}from"three/examples/jsm/controls/OrbitControls.js";import{BufferGeometryUtils}from"three/examples/jsm/utils/BufferGeometryUtils.js";import Stats from"stats.js";import{GUI}from"dat.gui";import{map,setCol}from"./Helpers";import{Sky}from"three/examples/jsm/objects/Sky.js";import{Water}from"three/examples/jsm/objects/Water.js";import{Clouds}from"./Clouds";import{computeBoundsTree,disposeBoundsTree,acceleratedRaycast,MeshBVH,MeshBVHVisualizer}from"three-mesh-bvh";import{Trees}from"./Trees";THREE.BufferGeometry.prototype.computeBoundsTree=computeBoundsTree,THREE.BufferGeometry.prototype.disposeBoundsTree=disposeBoundsTree,THREE.Mesh.prototype.raycast=acceleratedRaycast;var info=document.getElementById("info"),STATE={chill:"CHILL",walk:"WALK",run:"RUN"};export var p={water:0,sand:.01,grass:.3,rock:.5,snow:.7};var renderer,camera,scene,gui,controls,stats,clock,pmremGenerator,water,sun,sky,clouds,dirLight,trees,environment,collider,visualizer,player,mixer,capsuleInfo={radius:.5,segment:new THREE.Line3(new THREE.Vector3,new THREE.Vector3(0,-1,0))},params={firstPerson:!1,displayCollider:!1,displayBVH:!1,visualizeDepth:10,gravity:-15,playerSpeed:25,physicsSteps:5,reset,turbidity:10,rayleigh:4,mieCoefficient:.1,mieDirectionalG:.8,elevation:12,azimuth:90,enableWater:!0,enableSky:!0,enableLights:!0,enableClouds:!0,enableWireframe:!1,cameraX:0,cameraY:100,cameraZ:0},places=[],animations=[],state=STATE.chill,playerIsOnGround=!1,fwdPressed=!1,bkdPressed=!1,lftPressed=!1,rgtPressed=!1,playerVelocity=new THREE.Vector3,playerDirection=new THREE.Vector3(0,1,0),upVector=new THREE.Vector3(0,1,0),tempVector=new THREE.Vector3,tempVector2=new THREE.Vector3,tempBox=new THREE.Box3,tempMat=new THREE.Matrix4,tempSegment=new THREE.Line3;function init(){setupRenderer(),setupCamera(),setupMisc(),setupGUI(),setupCallbacks(),createWater(),createSky(),createLights(),createTerrain(),createPlayer()}function skyChanged(){var e=sky.material.uniforms;e.turbidity.value=params.turbidity,e.rayleigh.value=params.rayleigh,e.mieCoefficient.value=params.mieCoefficient,e.mieDirectionalG.value=params.mieDirectionalG;var a=THREE.MathUtils.degToRad(90-params.elevation),r=THREE.MathUtils.degToRad(params.azimuth);sun.setFromSphericalCoords(1,a,r),e.sunPosition.value.copy(sun),water&&water.material.uniforms.sunDirection.value.copy(sun).normalize(),scene.environment=pmremGenerator.fromScene(sky).texture}function createSky(){(sky=new Sky).scale.setScalar(1e4),scene.add(sky),clouds=new Clouds(30,scene),sun=new THREE.Vector3;var e=gui.addFolder("Environment");e.add(params,"enableWater").onChange((function(e){return water.visible=!water.visible})),e.add(params,"enableSky").onChange((function(e){return sky.visible=!sky.visible})),e.add(params,"enableLights").onChange((function(e){return dirLight.visible=!dirLight.visible})),e.add(params,"enableClouds").onChange((function(e){return clouds.mesh.visible=!clouds.mesh.visible})),e.add(params,"enableWireframe").onChange((function(e){return environment.children[0].material.wireframe=!environment.children[0].material.wireframe})),e.add(params,"turbidity",0,20,.1).onChange(skyChanged),e.add(params,"rayleigh",0,4,.001).onChange(skyChanged),e.add(params,"mieCoefficient",0,.1,.001).onChange(skyChanged),e.add(params,"mieDirectionalG",0,1,.001).onChange(skyChanged),e.add(params,"elevation",0,90,.1).onChange(skyChanged),e.add(params,"azimuth",-180,180,.1).onChange(skyChanged);var a=gui.addFolder("Camera");a.add(params,"cameraX",0,5e3,1).onChange(cameraChanged),a.add(params,"cameraY",0,5e3,1).onChange(cameraChanged),a.add(params,"cameraZ",0,5e3,1).onChange(cameraChanged),skyChanged()}function cameraChanged(){camera.position.x=params.cameraX,camera.position.y=params.cameraY,camera.position.z=params.cameraZ}function setupRenderer(){(renderer=new THREE.WebGLRenderer({antialias:!0})).setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth,window.innerHeight),renderer.shadowMap.enabled=!0,document.body.appendChild(renderer.domElement),scene=new THREE.Scene,pmremGenerator=new THREE.PMREMGenerator(renderer)}function createLights(){var e=1e4;(dirLight=new THREE.DirectionalLight(16777215,.5)).color.setHSL(.1,1,.95),dirLight.position.set(0,25,0),dirLight.position.multiplyScalar(30),dirLight.castShadow=!0,dirLight.shadow.mapSize.width=e,dirLight.shadow.mapSize.height=e,dirLight.shadow.camera.left=-e,dirLight.shadow.camera.right=e,dirLight.shadow.camera.top=e,dirLight.shadow.camera.bottom=-e,dirLight.shadow.camera.far=e,scene.add(dirLight)}function setupCamera(){(camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,50)).position.set(-31,-1468,-873),camera.far=1e4,camera.updateProjectionMatrix(),window.camera=camera;var e=new THREE.AudioListener;e.context.resume(),camera.add(e);var a=new THREE.Audio(e);(new THREE.AudioLoader).load("assets/images/ambient2.mp3",(function(e){a.setBuffer(e),a.setLoop(!0),a.setVolume(.5),a.play()}))}function createWater(){var e=new THREE.PlaneBufferGeometry(5e3,5e3);(water=new Water(e,{textureWidth:512,textureHeight:512,waterNormals:(new THREE.TextureLoader).load("assets/images/waternormals.jpg",(function(e){e.wrapS=e.wrapT=THREE.RepeatWrapping})),sunDirection:new THREE.Vector3,sunColor:16777215,waterColor:7695,distortionScale:8,fog:void 0!==scene.fog})).rotation.x=-Math.PI/2,water.position.y=-27,water.receiveShadow=!0,water.material.uniforms.size.value=10,scene.add(water)}function setupMisc(){clock=new THREE.Clock,(controls=new OrbitControls(camera,renderer.domElement)).maxPolarAngle=.495*Math.PI,controls.minDistance=40,controls.enableDamping=!0,stats=new Stats,document.body.appendChild(stats.dom)}function createPlayer(){var e=new DRACOLoader;e.setDecoderPath("three/examples/js/libs/draco/gltf/");var a=new GLTFLoader;a.setDRACOLoader(e),a.load("assets/images/Fox.glb",(function(e){var a=e.scene.children[0];a.scale.set(.05,.05,.05),(player=a).castShadow=!0,player.receiveShadow=!0,scene.add(player),console.log("player",player),reset(),animations=e.animations,(mixer=new THREE.AnimationMixer(a)).clipAction(animations[0]).play()}),void 0,(function(e){return console.error(e)}))}function setupGUI(){var e=(gui=new GUI).addFolder("Collision Detection");e.add(params,"displayCollider"),e.add(params,"displayBVH"),e.add(params,"visualizeDepth",1,20,1).onChange((function(e){visualizer.depth=e,visualizer.update()}));var a=gui.addFolder("Player");a.add(params,"gravity",-100,100,.01).onChange((function(e){params.gravity=parseFloat(e)})),a.add(params,"playerSpeed",1,20),a.add(params,"reset")}function setupCallbacks(){window.addEventListener("resize",(function(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}),!1),window.addEventListener("keydown",(function(e){switch(e.code){case"KeyC":params.firstPerson=!params.firstPerson,player.visible=!player.visible,params.firstPerson||camera.position.sub(controls.target).normalize().multiplyScalar(10).add(controls.target);break;case"KeyW":case"ArrowUp":fwdPressed=!0,doWalk();break;case"KeyS":case"ArrowDown":bkdPressed=!0,doWalk();break;case"KeyD":case"ArrowRight":rgtPressed=!0;break;case"KeyA":case"ArrowLeft":lftPressed=!0;break;case"Space":playerIsOnGround&&(playerVelocity.y=50)}})),window.addEventListener("keyup",(function(e){switch(e.code){case"KeyW":case"ArrowUp":fwdPressed=!1,doChill();break;case"KeyS":case"ArrowDown":bkdPressed=!1,doChill();break;case"KeyD":case"ArrowRight":rgtPressed=!1;break;case"KeyA":case"ArrowLeft":lftPressed=!1}}))}function createTerrain(){(new GLTFLoader).load("assets/images/high.glb",(function(e){return loadThing(e)}))}function loadThing(e){var a=e.scene;a.scale.setScalar(1e3);var r=new THREE.Box3;r.setFromObject(a),r.getCenter(a.position).negate(),a.updateMatrixWorld(!0);var t={};a.traverse((function(e){return colorTerrain(e,t)})),environment=new THREE.Group;var o=function(e){var a=[];if(t[e].forEach((function(e){var r=e.geometry.clone();r.applyMatrix4(e.matrixWorld),a.push(r)})),a.length){var r=BufferGeometryUtils.mergeBufferGeometries(a),o=new THREE.Mesh(r,new THREE.MeshStandardMaterial({vertexColors:THREE.VertexColors,flatShading:!0}));o.castShadow=!0,o.receiveShadow=!0,environment.add(o)}};for(var i in t)o(i);var n=[];environment.updateMatrixWorld(!0),environment.traverse((function(e){if(e.geometry){var a=e.geometry.clone();for(var r in a.applyMatrix4(e.matrixWorld),a.attributes)"position"!==r&&a.deleteAttribute(r);n.push(a)}}));var s=BufferGeometryUtils.mergeBufferGeometries(n,!1);s.boundsTree=new MeshBVH(s,{lazyGeneration:!1}),(collider=new THREE.Mesh(s)).material.wireframe=!0,collider.material.opacity=.5,collider.material.transparent=!0,visualizer=new MeshBVHVisualizer(collider,params.visualizeDepth),scene.add(visualizer),scene.add(collider),scene.add(environment),trees=new Trees(places,scene,gui),console.log("Number of trees: ",trees.num)}function colorTerrain(e,a){if(e.isMesh){e.geometry=e.geometry.toNonIndexed();var r=e.geometry,t=r.attributes.position.count,o=new THREE.BufferAttribute(new Float32Array(3*t),3);r.setAttribute("color",o);for(var i=r.attributes.color,n=r.attributes.position,s=Math.random(),l=0;l<i.count;l+=3){var d=n.getY(l),c=n.getY(l+1),m=n.getY(l+2),u=Math.max(d,Math.max(c,m));u=map(u,0,.0493,0,1),s=Math.random(),u<=p.water?setCol(i,l,0,.3,1):u<=p.sand?setCol(i,l,1,.8,.3):u<=p.grass?(places.length<70&&s>.995&&places.push(new THREE.Vector3(n.getX(l),n.getY(l),n.getZ(l))),setCol(i,l,.44,.7,.18)):u<=p.rock?setCol(i,l,.3,.3,.3):setCol(i,l,.92,.98,.98)}e.geometry.computeFaceNormals(),e.geometry.computeVertexNormals();var y=e.material.color.getHex();a[y]=a[y]||[],a[y].push(e)}}function reset(){playerVelocity.set(0,0,0),player.position.set(15.75,-3,30),camera.position.sub(controls.target),controls.target.copy(player.position),camera.position.add(player.position),controls.update()}function updatePlayer(e){if(player){window.playerVelocity=playerVelocity,playerVelocity.y+=e*params.gravity,player.position.addScaledVector(playerVelocity,e);var a=controls.getAzimuthalAngle();player.quaternion.setFromAxisAngle(playerDirection,a+Math.PI),fwdPressed&&(tempVector.set(0,0,-1).applyAxisAngle(upVector,a),player.position.addScaledVector(tempVector,params.playerSpeed*e)),bkdPressed&&(tempVector.set(0,0,1).applyAxisAngle(upVector,a),player.position.addScaledVector(tempVector,params.playerSpeed*e)),lftPressed&&(tempVector.set(-1,0,0).applyAxisAngle(upVector,a),player.position.addScaledVector(tempVector,params.playerSpeed*e)),rgtPressed&&(tempVector.set(1,0,0).applyAxisAngle(upVector,a),player.position.addScaledVector(tempVector,params.playerSpeed*e)),player.updateMatrixWorld(),tempBox.makeEmpty(),tempMat.copy(collider.matrixWorld).invert(),tempSegment.copy(capsuleInfo.segment),tempSegment.start.applyMatrix4(player.matrixWorld).applyMatrix4(tempMat),tempSegment.end.applyMatrix4(player.matrixWorld).applyMatrix4(tempMat),tempBox.expandByPoint(tempSegment.start),tempBox.expandByPoint(tempSegment.end),tempBox.min.addScalar(-capsuleInfo.radius),tempBox.max.addScalar(capsuleInfo.radius),collider.geometry.boundsTree.shapecast(collider,(function(e){return e.intersectsBox(tempBox)}),(function(e){var a=tempVector,r=tempVector2,t=e.closestPointToSegment(tempSegment,a,r);if(t<capsuleInfo.radius){var o=capsuleInfo.radius-t,i=r.sub(a).normalize();tempSegment.start.addScaledVector(i,o),tempSegment.end.addScaledVector(i,o)}}));var r=tempVector;r.copy(tempSegment.start).applyMatrix4(collider.matrixWorld);var t=tempVector2;t.subVectors(r,player.position),player.position.copy(r),(playerIsOnGround=t.y>Math.abs(e*playerVelocity.y*.25))?playerVelocity.set(0,0,0):(t.normalize(),playerVelocity.addScaledVector(t,-t.dot(playerVelocity))),camera.position.sub(controls.target),controls.target.copy(player.position),camera.position.add(player.position),player.position.y<-100&&reset()}}function doWalk(){state!==STATE.walk&&(mixer.stopAllAction(),mixer.clipAction(animations[1]).play(),state=STATE.walk)}function doChill(){state!==STATE.chill&&(mixer.stopAllAction(),mixer.clipAction(animations[0]).play(),state=STATE.chill)}function render(){stats.update(),requestAnimationFrame(render);var e=Math.min(clock.getDelta(),.1);if(mixer&&mixer.update(e),params.firstPerson?(controls.maxPolarAngle=Math.PI,controls.minDistance=1e-4,controls.maxDistance=1e-4):(controls.maxPolarAngle=Math.PI/2,controls.minDistance=1,controls.maxDistance=2e3),collider){collider.visible=params.displayCollider,visualizer.visible=params.displayBVH;for(var a=params.physicsSteps,r=0;r<a;r++)updatePlayer(e/a)}controls.update(),water&&(water.material.uniforms.time.value+=1/60),clouds.mesh&&(clouds.mesh.position.x+=Math.sin(10*e)),renderer.render(scene,camera)}init(),render();